{% comment %}
Initial HTML structure added
{% endcomment %}


{{ 'featured-products.css' | asset_url | stylesheet_tag }}

<section class="featured-products" data-section-id="{{ section.id }}">
  <div class="featured-products__container">
    <h1 class="featured-products__title">Featured Products</h1>

    {% assign cart_ids = cart.items | map: 'product_id' %}

    <div class="featured-products__grid">
      
      {% if section.settings.collection %}
        {% for product in section.settings.collection.products %}
          
          {% unless cart_ids contains product.id %}

          <article class="product-card">
            <div class="product-card__image-wrapper">
              {% if product.featured_image %}
                <img src="{{ product.featured_image | img_url: '520x340', crop: 'center' }}" 
                     alt="{{ product.title }}"
                     loading="lazy">
              {% else %}
                <div style="width: 100%; height: 340px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #999;">
                  No image
                </div>
              {% endif %}
            </div>

            <div class="product-card__content">
              <h2 class="product-card__title">{{ product.title }}</h2>

              <button 
                class="product-card__button add-to-cart"
                data-variant-id="{{ product.variants.first.id }}"
              >
                Add to cart â€“ {{ product.price | money }}
              </button>
            </div>
          </article>

          {% endunless %}
        {% endfor %}
      {% endif %}

    </div>
  </div>
</section>

<script>
function initFeaturedProductsSection() {
  document.querySelectorAll(".add-to-cart").forEach(button => {
    button.addEventListener("click", async () => {
      const variantId = button.dataset.variantId;

      await fetch("/cart/add.js", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: variantId, quantity: 1 })
      });

      document.documentElement.dispatchEvent(new CustomEvent('cart:open'));

      const url = `${window.location.pathname}?section_id={{ section.id }}`;
      const response = await fetch(url);
      const html = await response.text();

      const parser = new DOMParser();
      const newDoc = parser.parseFromString(html, "text/html");

      const newGrid = newDoc.querySelector(".featured-products__grid");
      const currentGrid = document.querySelector(".featured-products__grid");

      if (newGrid && currentGrid) {
        currentGrid.innerHTML = newGrid.innerHTML;
      }

      initFeaturedProductsSection();
    });
  });
}

initFeaturedProductsSection();
</script>

{% schema %}
{
  "name": "Featured products",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Select collection"
    }
  ],
  "presets": [
    {
      "name": "Featured Products Custom"
    }
  ]
}
{% endschema %}
